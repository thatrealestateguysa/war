<!doctype html>
<html>
<head>
  <meta charset='utf-8'/>
  <meta name='viewport' content='width=device-width,initial-scale=1'/>
  <title>KW Explore — Dashboard</title>
  <style>
    :root{ --bg:#0b0b0e; --panel:#16161a; --ink:#fff; --sub:#bbb; --a1:#FF3B30; --a2:#FF9500; --kw-red:#C70000;}
    html,body{ height:100%; margin:0; padding:0; background:var(--bg); color:var(--ink); font-family:Inter,system-ui,Arial,sans-serif; overflow: hidden;}
    .wrap{ padding:12px; height: calc(100% - 24px); display: flex; flex-direction: column; }
    .row{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
    .card{ background:var(--panel); border:1px solid #2a2a2a; border-radius:14px; padding:12px; display: flex; flex-direction: column;}
    .kpi{ font-weight:800; font-size:44px; background:linear-gradient(90deg,var(--a1),var(--a2)); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .muted{ color:var(--sub); font-size:12px; }
    .hdr{ display:flex; align-items:center; justify-content:space-between; margin:4px 0 10px; flex-wrap: wrap; gap: 8px;}
    .pill{ font-size:11px; padding:4px 8px; border-radius:999px; background:linear-gradient(90deg,var(--a1),var(--a2)); color:#000; font-weight:600; }
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th,td{ padding:8px 6px; border-bottom:1px solid #2a2a2a; text-align: left; }
    tr:hover{ background:rgba(255,59,48,0.08); }
    select,input,button{ background:#111827; color:#fff; border:1px solid var(--kw-red); border-radius:10px; padding:6px 10px; }
    button { cursor: pointer; background-color: var(--kw-red); font-weight: bold; }
    .col-4{ grid-column:span 12; } .col-8{ grid-column:span 12; }
    .table-container { flex-grow: 1; overflow-y: auto; }
    @media(min-width:900px){ .col-4{ grid-column:span 4; } .col-8{ grid-column:span 8; } }
  </style>
  <script type='text/javascript' src='https://www.gstatic.com/charts/loader.js'></script>
  <script>
    // ## CONFIGURATION ##
    // Paste your Google Apps Script Web App URL here
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwUxz34rLqeLQAzTWomdKKqBbUsyJlxxhf5HXOiOjx68cAemki07KnfuGNIGrC6h68s/exec';

    google.charts.load('current', {'packages':['corechart','bar']});

    function $(id){ return document.getElementById(id); }
    function setLoading(is){ $('loading').style.display = is ? 'block' : 'none'; }
    function setError(msg){ var el=$('error'); el.textContent = msg || ''; el.style.display = msg ? 'block' : 'none'; }

    // Fetches data from the Google Apps Script Web App
    async function fetchData(){
      setLoading(true); setError('');
      const muni = $('municipality').value || '';
      const url = GAS_URL + (muni ? '?municipality=' + encodeURIComponent(muni) : '');

      try {
        const res = await fetch(url, { mode: 'cors' });
        if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
        const payload = await res.json();
        if (payload.success === false) throw new Error(payload.error || 'The backend script returned an error.');
        renderAll(payload);
      } catch (err) {
        setLoading(false);
        setError(String(err));
        console.error(err);
      }
    }

    function renderAll(payload){
      setLoading(false);
      try{
        const date = payload.date ? new Date(payload.date).toLocaleDateString('en-ZA', { timeZone: 'UTC'}) : '—';
        const agencies = payload.agencies || [];
        const agents = payload.agents || [];
        const series = payload.timeseries || [];
        const munis = payload.municipalities || [];
        window.__lastDate = date; window.__lastAgencies = agencies; window.__lastAgents = agents; window.__lastSeries = series;

        const selMuni = $('municipality').value;
        const muniSelect = $('municipality');
        const currentOptions = Array.from(muniSelect.options).map(o => o.value);
        if (munis.length > 0 && currentOptions.length <= 1) {
            muniSelect.innerHTML = '<option value="">All Municipalities</option>';
            munis.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                muniSelect.appendChild(opt);
            });
            muniSelect.value = selMuni;
        }

        $('latest').textContent = date;

        // KPIs
        let kw = 0, exp = 0;
        for (let i=0; i<agencies.length; i++){
          const name = (agencies[i].agency||'').toLowerCase();
          if (name.includes('keller williams explore')) kw = agencies[i].total||0;
          if (name.includes('exp south africa')) exp = agencies[i].total||0;
        }
        $('kpi-kw').textContent = kw; $('kpi-exp').textContent = exp;
        $('kpi-top-agency-name').textContent = agencies[0] ? agencies[0].agency : '—';
        $('kpi-top-agency-val').textContent  = agencies[0] ? agencies[0].total : '—';
        
        // Bar: Top 10 agencies
        const barData = new google.visualization.DataTable();
        barData.addColumn('string','Agency');
        barData.addColumn('number','Listings');
        const top10 = agencies.slice(0,10);
        top10.forEach(item => barData.addRow([item.agency, Number(item.total||0)]));
        const barOpts = {
          legend:{position:'none'}, backgroundColor:'transparent',
          chartArea:{ left:120, top:20, right:20, bottom:60 },
          hAxis:{ textStyle:{color:'#fff'}, gridlines: { color: 'transparent' } },
          vAxis:{ textStyle:{color:'#fff'} }, colors:['#FF6A00']
        };
        new google.visualization.BarChart($('bar')).draw(barData, barOpts);

        // Line: Agency trends
        const sel = series.slice(0,4);
        const allDatesSet = new Set();
        sel.forEach(s => s.points.forEach(p => allDatesSet.add(p.date)));
        const allDates = Array.from(allDatesSet).sort();
        const lineDataArr = [['Date']];
        sel.forEach(s => lineDataArr[0].push(s.agency));
        allDates.forEach(d => {
            let row = [new Date(d)];
            sel.forEach(s => {
                let point = s.points.find(p => p.date === d);
                row.push(point ? Number(point.total || 0) : null);
            });
            lineDataArr.push(row);
        });
        const lineData = google.visualization.arrayToDataTable(lineDataArr);
        const lineOpts = {
          backgroundColor:'transparent', legend:{ textStyle:{color:'#fff'} },
          chartArea:{ left:60, top:20, right:20, bottom:40 },
          hAxis:{ textStyle:{color:'#fff'}, format: 'MMM d', timeZone: 'UTC' },
          vAxis:{ textStyle:{color:'#fff'}, gridlines: { color: '#333' } },
          colors:['#FF3B30','#FF9500','#34C759','#0A84FF']
        };
        new google.visualization.LineChart($('line')).draw(lineData, lineOpts);

        // Table: Top 50 agents + search
        applyAgentFilter();
      } catch(e){ console.error(e); setError(String(e.stack)); }
    }

    function applyAgentFilter(){
      const agents = window.__lastAgents || [];
      const q = ($('search').value || '').toLowerCase();
      const filtered = q ? agents.filter(agent =>
          (agent.agent||'').toLowerCase().includes(q) ||
          (agent.agency||'').toLowerCase().includes(q)
      ) : agents;

      const tbody = $('agent-tbody'); tbody.innerHTML='';
      filtered.forEach((item, index) => {
        let tr = document.createElement('tr');
        tr.innerHTML = `<td>${index + 1}</td><td>${item.agent||''}</td><td>${item.agency||''}</td><td>${item.total||0}</td>`;
        tbody.appendChild(tr);
      });
    }

    document.addEventListener('DOMContentLoaded', function(){
      $('refresh').addEventListener('click', fetchData);
      $('municipality').addEventListener('change', fetchData);
      $('search').addEventListener('input', applyAgentFilter);
      google.charts.setOnLoadCallback(fetchData);
    });
  </script>
</head>
<body>
  <div class="wrap">
    <h3 style="margin:4px 0 8px">KW Explore — Market Leaderboard</h3>

    <div class="card" style="margin-bottom:10px;">
      <div class="hdr">
        <div style="display:flex; gap:8px; align-items:center;">
          <label class="muted">Municipality</label>
          <select id="municipality"><option value="">All Municipalities</option></select>
        </div>
        <div class="pill">Latest: <span id="latest">—</span></div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="search" placeholder="Search agents/agencies…" />
          <button id="refresh">Refresh</button>
        </div>
      </div>
      <div id="loading" class="muted" style="display:none;">Loading live data…</div>
      <div id="error" style="display:none; color:#ff6b6b; font-size:12px; white-space: pre-wrap;"></div>
    </div>

    <div class="row" style="margin-bottom:10px;">
      <div class="card col-4">
        <div class="muted">KW Explore</div>
        <div id="kpi-kw" class="kpi">0</div>
        <div class="muted">Active listings</div>
      </div>
      <div class="card col-4">
        <div class="muted">eXp South Africa</div>
        <div id="kpi-exp" class="kpi">0</div>
        <div class="muted">Active listings</div>
      </div>
      <div class="card col-4">
        <div class="muted">Top Agency</div>
        <div id="kpi-top-agency-name" style="font-size:18px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">—</div>
        <div id="kpi-top-agency-val" class="kpi" style="font-size:36px;">—</div>
      </div>
    </div>

    <div class="row" style="margin-bottom:10px; flex-grow: 1; min-height: 0;">
      <div class="card col-8">
        <div class="hdr"><div>Top 10 Agencies</div><div class="pill">Listings</div></div>
        <div id="bar" style="height:100%;"></div>
      </div>
      <div class="card col-4">
        <div class="hdr"><div>Top Agents</div><div class="pill">Top 50</div></div>
         <div class="table-container">
          <table>
            <thead><tr><th>#</th><th>Agent</th><th>Agency</th><th>Listings</th></tr></thead>
            <tbody id="agent-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</body>
</html>
